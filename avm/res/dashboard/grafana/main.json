{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.26.170.59819",
      "templateHash": "2898209003008065260"
    },
    "name": "Azure Grafana Dashboard",
    "description": "This module deploys an Azure Grafana Dashboard.",
    "owner": "InnofactorOrg/module-maintainers"
  },
  "parameters": {
    "name": {
      "type": "string",
      "minLength": 5,
      "maxLength": 50,
      "metadata": {
        "description": "Required. Name of your Azure Grafana Dashboard."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Optional. Location for all Resources."
      }
    },
    "grafanaSku": {
      "type": "string",
      "defaultValue": "Standard",
      "allowedValues": [
        "Standard"
      ],
      "metadata": {
        "description": "Optional. Tier of your Azure Grafana Dashboard."
      }
    },
    "zoneRedundancy": {
      "type": "string",
      "defaultValue": "Disabled",
      "allowedValues": [
        "Disabled",
        "Enabled"
      ],
      "metadata": {
        "description": "Optional. Whether or not zone redundancy is enabled for this Grafana dashboard."
      }
    },
    "apiKey": {
      "type": "string",
      "defaultValue": "Disabled",
      "allowedValues": [
        "Disabled",
        "Enabled"
      ],
      "metadata": {
        "description": "Optional. The api key setting of the Grafana instance."
      }
    },
    "publicNetworkAccess": {
      "type": "string",
      "nullable": true,
      "allowedValues": [
        "Enabled",
        "Disabled"
      ],
      "metadata": {
        "description": "Optional. Whether or not public network access is allowed for this resource. For security reasons it should be disabled. If not specified, it will be disabled by default if private endpoints are set and networkRuleSetIpRules are not set.  Note, requires the 'acrSku' to be 'Premium'."
      }
    },
    "deterministicOutboundIP": {
      "type": "string",
      "defaultValue": "Disabled",
      "allowedValues": [
        "Disabled",
        "Enabled"
      ],
      "metadata": {
        "description": "Optional. Whether a Grafana instance uses deterministic outbound IPs for this instancey."
      }
    },
    "tags": {
      "type": "object",
      "nullable": true,
      "metadata": {
        "description": "Optional. Tags of the resource."
      }
    },
    "enableTelemetry": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Optional. Enable/Disable usage telemetry for module."
      }
    }
  },
  "resources": {
    "avmTelemetry": {
      "condition": "[parameters('enableTelemetry')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2023-07-01",
      "name": "[format('46d3xbcp.res.dashboard-grafana.{0}.{1}', replace('-..--..-', '.', '-'), substring(uniqueString(deployment().name, parameters('location')), 0, 4))]",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": [],
          "outputs": {
            "telemetry": {
              "type": "String",
              "value": "For more information, see https://aka.ms/avm/TelemetryInfo"
            }
          }
        }
      }
    },
    "grafana": {
      "type": "Microsoft.Dashboard/grafana",
      "apiVersion": "2023-09-01",
      "name": "[parameters('name')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "[parameters('grafanaSku')]"
      },
      "properties": {
        "apiKey": "[if(equals(parameters('grafanaSku'), 'Standard'), parameters('apiKey'), null())]",
        "deterministicOutboundIP": "[if(equals(parameters('grafanaSku'), 'Standard'), parameters('deterministicOutboundIP'), null())]",
        "publicNetworkAccess": "[if(not(empty(parameters('publicNetworkAccess'))), parameters('publicNetworkAccess'), null())]",
        "zoneRedundancy": "[if(equals(parameters('grafanaSku'), 'Standard'), parameters('zoneRedundancy'), null())]"
      }
    }
  },
  "outputs": {
    "name": {
      "type": "string",
      "metadata": {
        "description": "The Name of the Azure Grafana Dashboard."
      },
      "value": "[parameters('name')]"
    },
    "loginServer": {
      "type": "string",
      "metadata": {
        "description": "The reference to the Azure Grafana Dashboard."
      },
      "value": "[reference('grafana').endpoint]"
    },
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Azure Grafana Dashboard."
      },
      "value": "[resourceGroup().name]"
    },
    "resourceId": {
      "type": "string",
      "metadata": {
        "description": "The resource ID of the Azure Grafana Dashboard."
      },
      "value": "[resourceId('Microsoft.Dashboard/grafana', parameters('name'))]"
    },
    "systemAssignedMIPrincipalId": {
      "type": "string",
      "metadata": {
        "description": "The principal ID of the system assigned identity."
      },
      "value": "[coalesce(tryGet(tryGet(reference('grafana', '2023-09-01', 'full'), 'identity'), 'principalId'), '')]"
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "The location the resource was deployed into."
      },
      "value": "[reference('grafana', '2023-09-01', 'full').location]"
    }
  }
}